@using Microsoft.AspNetCore.Identity
@inject SignInManager<IdentityUser> SignInManager
@inject UserManager<IdentityUser> UserManager
@functions {
    public class PendingRequest {
        public string Member { get; set; }
        public string Book { get; set; }
        public DateTime Date { get; set; }
    }
    public class ActivityFeedItem {
        public string Type { get; set; }
        public string Member { get; set; }
        public string Book { get; set; }
        public int? Amount { get; set; }
        public string Time { get; set; }
    }
}
@{
    ViewData["Title"] = "Librarian Dashboard";
    var isLibrarian = User.IsInRole("Librarian");
    var userName = User.Identity.Name ?? "Librarian";
    // Mock data for demonstration
    var stats = new {
        TotalBooks = 1247,
        ActiveMembers = 342,
        IssuedToday = 23,
        Overdue = 7,
        MostBorrowed = "Clean Code"
    };
    var pendingRequests = new List<PendingRequest> {
        new PendingRequest { Member = "Abdul Aziz", Book = "The Great Gatsby", Date = DateTime.Now.AddHours(-2) },
        new PendingRequest { Member = "Michael Chen", Book = "1984", Date = DateTime.Now.AddHours(-4) }
    };
    var activityFeed = new List<ActivityFeedItem> {
        new ActivityFeedItem { Type = "Returned", Member = "Lisa Brown", Book = "Pride and Prejudice", Time = "10 min ago" },
        new ActivityFeedItem { Type = "Issued", Member = "John Smith", Book = "1984", Time = "30 min ago" },
        new ActivityFeedItem { Type = "Fine", Member = "Emily Davis", Amount = 20, Time = "1 hr ago" }
    };
}
@if (!isLibrarian)
{
    <div class="alert alert-danger mt-5 text-center">Access denied. Only librarians can view this dashboard.</div>
    return;
}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    .dashboard-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
    }
    .profile-dropdown {
        position: relative;
        display: inline-block;
    }
    .profile-dropdown-content {
        display: none;
        position: absolute;
        right: 0;
        background: #fff;
        min-width: 180px;
        box-shadow: 0 8px 24px rgba(0,0,0,0.12);
        border-radius: 10px;
        z-index: 1000;
    }
    .profile-dropdown:hover .profile-dropdown-content {
        display: block;
    }
    .profile-dropdown-content a {
        color: #333;
        padding: 12px 16px;
        text-decoration: none;
        display: block;
        border-radius: 10px;
    }
    .profile-dropdown-content a:hover {
        background: #f3f4f6;
    }
    .dark-mode {
        background: #18181b !important;
        color: #f3f4f6 !important;
    }
    .dark-mode .card, .dark-mode .card-header, .dark-mode .profile-dropdown-content {
        background: #23232a !important;
        color: #f3f4f6 !important;
    }
    .dark-mode .btn {
        border-color: #6366f1 !important;
        color: #a5b4fc !important;
    }
    .dark-mode .btn:hover {
        background: #6366f1 !important;
        color: #fff !important;
    }
    .card {
        transition: box-shadow 0.2s, transform 0.2s;
    }
    .card:hover {
        box-shadow: 0 8px 32px rgba(99,102,241,0.12);
        transform: translateY(-2px) scale(1.01);
    }
    .quick-action-tile {
        transition: box-shadow 0.2s, transform 0.2s;
        cursor: pointer;
    }
    .quick-action-tile:hover {
        box-shadow: 0 8px 32px rgba(99,102,241,0.18);
        transform: translateY(-2px) scale(1.03);
    }
</style>
<div class="container-fluid py-4">
    <div class="dashboard-header">
        <h2 class="fw-bold mb-0"><i class="fas fa-chalkboard-teacher me-2"></i>Librarian Dashboard</h2>
        <div class="d-flex align-items-center gap-3">
            <button class="btn btn-outline-dark" id="toggleDark"><i class="fas fa-moon"></i></button>
            <div class="profile-dropdown">
                <form id="logoutForm" method="post" action="/Identity/Account/Logout">
                    <button type="submit" class="btn btn-outline-primary"><i class="fas fa-sign-out-alt"></i> Logout</button>
                </form>
            </div>
        </div>
    </div>
    <div class="row g-4 mb-4">
        <div class="col-md-2 col-6">
            <div class="card shadow-sm border-0 text-center">
                <div class="card-body">
                    <i class="fas fa-book fa-2x text-primary mb-2" data-bs-toggle="tooltip" title="Total books in library"></i>
                    <h6 class="fw-bold">Total Books</h6>
                    <h3>@stats.TotalBooks</h3>
                </div>
            </div>
        </div>
        <div class="col-md-2 col-6">
            <div class="card shadow-sm border-0 text-center">
                <div class="card-body">
                    <i class="fas fa-users fa-2x text-success mb-2" data-bs-toggle="tooltip" title="Active members"></i>
                    <h6 class="fw-bold">Active Members</h6>
                    <h3>@stats.ActiveMembers</h3>
                </div>
            </div>
        </div>
        <div class="col-md-2 col-6">
            <div class="card shadow-sm border-0 text-center">
                <div class="card-body">
                    <i class="fas fa-exchange-alt fa-2x text-info mb-2" data-bs-toggle="tooltip" title="Books issued today"></i>
                    <h6 class="fw-bold">Issued Today</h6>
                    <h3>@stats.IssuedToday</h3>
                </div>
            </div>
        </div>
        <div class="col-md-2 col-6">
            <div class="card shadow-sm border-0 text-center">
                <div class="card-body">
                    <i class="fas fa-exclamation-triangle fa-2x text-danger mb-2" data-bs-toggle="tooltip" title="Overdue returns"></i>
                    <h6 class="fw-bold">Overdue</h6>
                    <h3>@stats.Overdue</h3>
                </div>
            </div>
        </div>
        <div class="col-md-4 col-12">
            <div class="card shadow-sm border-0 text-center h-100">
                <div class="card-body d-flex flex-column justify-content-center align-items-center">
                    <i class="fas fa-star fa-2x text-warning mb-2" data-bs-toggle="tooltip" title="Most borrowed book this month"></i>
                    <h6 class="fw-bold">Most Borrowed (Month)</h6>
                    <h4>@stats.MostBorrowed</h4>
                </div>
            </div>
        </div>
    </div>
    <div class="row g-4 mb-4">
        <div class="col-lg-8">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-header bg-light fw-bold"><i class="fas fa-chart-bar"></i> Monthly Borrowing Chart</div>
                <div class="card-body">
                    <canvas id="borrowChart" height="100"></canvas>
                </div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                    <span class="fw-bold"><i class="fas fa-clock"></i> Pending Book Requests</span>
                    <div>
                        <button class="btn btn-outline-secondary btn-sm me-2">Today</button>
                        <button class="btn btn-outline-secondary btn-sm">This Week</button>
                    </div>
                </div>
                <div class="card-body p-0">
                    <table class="table mb-0">
                        <thead>
                            <tr>
                                <th>Member</th>
                                <th>Book</th>
                                <th>Request Date</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var req in pendingRequests)
                            {
                                <tr>
                                    <td>@req.Member</td>
                                    <td>@req.Book</td>
                                    <td>@req.Date.ToString("yyyy-MM-dd HH:mm")</td>
                                    <td>
                                        <button class="btn btn-success btn-sm me-1" data-bs-toggle="tooltip" title="Approve"><i class="fas fa-check"></i></button>
                                        <button class="btn btn-danger btn-sm" data-bs-toggle="tooltip" title="Reject"><i class="fas fa-times"></i></button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <div class="row g-4 mb-4">
        <div class="col-lg-8">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-header bg-light fw-bold"><i class="fas fa-bolt"></i> Quick Actions</div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-6 col-md-4 col-lg-3">
                            <a href="/Librarian/AddBook" class="btn btn-outline-primary w-100 py-3 d-flex flex-column align-items-center quick-action-tile" data-bs-toggle="tooltip" title="Add a new book to the library">
                                <i class="fas fa-plus fa-2x mb-2"></i> Add Book
                            </a>
                        </div>
                        <div class="col-6 col-md-4 col-lg-3">
                            <a href="#" class="btn btn-outline-secondary w-100 py-3 d-flex flex-column align-items-center quick-action-tile" data-bs-toggle="tooltip" title="Edit existing books">
                                <i class="fas fa-edit fa-2x mb-2"></i> Edit Books
                            </a>
                        </div>
                        <div class="col-6 col-md-4 col-lg-3">
                            <a href="#" class="btn btn-outline-info w-100 py-3 d-flex flex-column align-items-center quick-action-tile" data-bs-toggle="tooltip" title="Search the book inventory">
                                <i class="fas fa-search fa-2x mb-2"></i> Search Inventory
                            </a>
                        </div>
                        <div class="col-6 col-md-4 col-lg-3">
                            <a href="#" class="btn btn-outline-success w-100 py-3 d-flex flex-column align-items-center quick-action-tile" data-bs-toggle="tooltip" title="View member profiles">
                                <i class="fas fa-user fa-2x mb-2"></i> Member Profiles
                            </a>
                        </div>
                        <div class="col-6 col-md-4 col-lg-3">
                            <a href="#" class="btn btn-outline-warning w-100 py-3 d-flex flex-column align-items-center quick-action-tile" data-bs-toggle="tooltip" title="Generate library reports">
                                <i class="fas fa-chart-bar fa-2x mb-2"></i> Generate Report
                            </a>
                        </div>
                        <div class="col-6 col-md-4 col-lg-3">
                            <a href="#" class="btn btn-outline-dark w-100 py-3 d-flex flex-column align-items-center quick-action-tile" data-bs-toggle="tooltip" title="Issue or return a book">
                                <i class="fas fa-hand-holding fa-2x mb-2"></i> Issue/Return Book
                            </a>
                        </div>
                        <div class="col-6 col-md-4 col-lg-3">
                            <a href="/Books" class="btn btn-outline-primary w-100 py-3 d-flex flex-column align-items-center quick-action-tile" data-bs-toggle="tooltip" title="View all books in the library">
                                <i class="fas fa-books fa-2x mb-2"></i> Books
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-header bg-light fw-bold"><i class="fas fa-list"></i> Daily Activity Feed</div>
                <div class="card-body" style="max-height: 350px; overflow-y: auto;">
                    <ul class="list-group list-group-flush">
                        @foreach (var act in activityFeed)
                        {
                            <li class="list-group-item d-flex align-items-center">
                                @if (act.Type == "Returned")
                                {
                                    <i class="fas fa-undo text-success me-2"></i>
                                    <span><strong>@act.Member</strong> returned <strong>@act.Book</strong> (@act.Time)</span>
                                }
                                else if (act.Type == "Issued")
                                {
                                    <i class="fas fa-book-open text-primary me-2"></i>
                                    <span><strong>@act.Member</strong> borrowed <strong>@act.Book</strong> (@act.Time)</span>
                                }
                                else if (act.Type == "Fine")
                                {
                                    <i class="fas fa-money-bill-wave text-danger me-2"></i>
                                    <span><strong>@act.Member</strong> paid fine <strong>@act.Amount BDT</strong> (@act.Time)</span>
                                }
                            </li>
                        }
                    </ul>
                </div>
            </div>
        </div>
    </div>
    <div class="row g-4 mb-4">
        <div class="col-12">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-light fw-bold"><i class="fas fa-file-alt"></i> Reports</div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <a href="#" class="btn btn-outline-primary w-100"><i class="fas fa-file-excel"></i> Daily Borrowing Report</a>
                        </div>
                        <div class="col-md-3">
                            <a href="#" class="btn btn-outline-danger w-100"><i class="fas fa-file-pdf"></i> Fine Collection Summary</a>
                        </div>
                        <div class="col-md-3">
                            <a href="#" class="btn btn-outline-warning w-100"><i class="fas fa-exclamation-triangle"></i> Overdue Report</a>
                        </div>
                        <div class="col-md-3">
                            <a href="#" class="btn btn-outline-success w-100"><i class="fas fa-users"></i> Member Borrowing Summary</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
    // Dark mode toggle
    document.getElementById('toggleDark').addEventListener('click', function () {
        document.body.classList.toggle('dark-mode');
    });
    // Chart.js bar chart for monthly borrowing
    var ctx = document.getElementById('borrowChart').getContext('2d');
    var borrowChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug'],
            datasets: [{
                label: 'Books Borrowed',
                data: [120, 150, 180, 140, 200, 170, 210, 190],
                backgroundColor: 'rgba(99,102,241,0.7)'
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { display: false },
                tooltip: { enabled: true }
            },
            scales: {
                y: { beginAtZero: true }
            }
        }
    });
    // Enable Bootstrap tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.forEach(function (tooltipTriggerEl) {
        new bootstrap.Tooltip(tooltipTriggerEl);
    });
    // Redirect to home after logout
    document.getElementById('logoutForm').addEventListener('submit', function (e) {
        setTimeout(function () {
            window.location.href = '/';
        }, 100);
    });
</script>